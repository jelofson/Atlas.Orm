<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Mapper Relationships</title>
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/yeti/bootstrap.min.css">
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-base16-ateliersulphurpool.light.css"/>
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
<style>
    body, html {
        height: 100%;
        padding-top: 36px;
        position: relative;
    }

    img {
        max-width: 100%;
    }

    code span {
        white-space: nowrap;
    }

    .highlight {
        background: #FFFF88;
    }

    .page-wrapper {
        min-height: 100%;
        padding-bottom: 170px;
        position: relative;
    }

    .box-header {
        position: relative;
    }

    /* Header Section */
    header {
        background: white;
        color: black;
        font-size: 16px;
        font-weight: 300;
    }

    h1:first-child {
        margin-top: 0;
    }

    /* anchor link will be displayed after the static top nav */
    h1:before,
    h2:before,
    h3:before,
    h4:before,
    h5:before,
    h6:before {
        display: block;
        content: " ";
        margin-top: -64px;
        height: 64px;
        visibility: hidden;
    }

    .navbar-brand {
        padding: 0;
    }

    .navbar-brand img {
        max-height: 100%;
    }

    /* Content Section */
    #content {
        margin-bottom: 17px;
        font-size: 17px;
        min-height: 200px;
    }

    .breadcrumb {
        position: relative;
        z-index: 999;
    }

    .links {
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        padding: 16px 0;
    }

    .links .prev {
        text-align: left;
    }

    .links .parent {
        text-align: center;
    }

    .links .next {
        text-align: right;
    }

    /* Search */
    .form-search {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
    }

    @media (max-width: 767px) {
        .form-search {
            position: relative;
            margin-top: 0;
        }
    }

    .form-search .form-control {
        border: 0;
        width: 80px;
    }

    @media (max-width: 767px) {
        .form-search .form-control {
            width: 100% !important;
        }
    }

    .form-search .list-search-results {
        position: relative;
    }

    .form-search .list-search-results ul {
        background: #eee;
        border: 1px solid inherit;
        list-style: none;
        max-height: 300px;
        overflow: auto;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 999;
    }

    .form-search .list-search-results ul li:nth-child(even) {
        background: rgba(255, 255, 255, 0.3)
    }

    .form-search .list-search-results ul li.selected {
        background: #ccc;
    }

    .form-search .list-search-results ul li a {
        display: block;
        padding: 4px 8px;
    }

    /* TOC */
    .list-toc .list-group-item {
        background: 0 none;
        position: relative;
        font-weight: bold;
        padding: 0;
    }

    .list-toc .list-group-item .row {
        padding: 7px 0;
    }

    .list-toc .list-group-item .text-number {
        padding-left: 10px;
    }

    .list-toc .list-toc-nested .list-group-item {
        font-weight: normal;
        border: 0 none !important;
    }

    .list-toc .list-toc-nested {
        margin-bottom: 0;
        padding-bottom: 10px;
    }

    .list-toc .list-group-item .bbt-toc-toggle {
        display: block;
        position: absolute;
        top: 5px;
        right: 10px;
        font-weight: normal;
    }

    .list-toc .list-group-item .bbt-toc-toggle:before {
        content: "";
        display: block;
    }

    .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
        content: "";
        display: block;
    }

    .list-toc > li:nth-child(2n+1) {
        background: rgba(0, 0, 0, 0.03);
    }

    .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
    .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
    .bbt-theme-slate .list-toc > li:nth-child(2n+1),
    .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
        background: rgba(255, 255, 255, 0.05);
    }

    .list-toc .list-group-item {
        border-bottom: 0 none;
        border-left: 0 none;
        border-right: 0 none;
        font-size: inherit;
    }

    .list-toc .list-group-item:first-child {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }

    .list-toc .list-group-item:last-child {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* Left navigation */
    .nav-left ul li a {
        padding-top: 3px;
        padding-bottom: 3px;
        border-left: 1px solid transparent;
    }

    .nav-left ul li.active a,
    .nav-left ul li a:hover {
        background: none !important;
        color: inherit;
        border-color: inherit;
    }

    .navbar-top {
        position: relative;
    }

    .affix {
        top: 60px;
    }

    .badge {
        border-radius: 4px;
        padding: 5px;
    }

    /* Footer Section */
    footer {
        color: black;
        background: white;
        width: 100%;
        position: absolute;
        bottom: 0;
    }

    footer #copyright {
        padding: 30px;
        text-align: center;
        color: #444;
    }

    footer #copyright p {
        margin: 0;
    }

    footer #copyright span a {
        color: white;
    }

    /* Top Navigation */
    @media (max-width: 767px) {
        ul.navbar-nav {
            margin: 0 -15px
        }

        ul.navbar-nav li {
            border-radius: 0;
        }

        ul.navbar-nav li ul {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
            float: none;
            left: auto;
            padding: 0;
            position: static;
        }

        ul.navbar-nav li ul li a {
            padding: 8px 30px;
        }

        ul.navbar-nav li ul li ul li a {
            padding: 6px 40px;
        }
    }

    @media (min-width: 768px) {

        ul.navbar-nav li {
            display: block;
            position: relative;
            float: left;
        }

        ul.navbar-nav li ul {
            display: none;
        }

        ul.navbar-nav li a {
            display: block;
        }

        ul.navbar-nav li:hover > ul {
            display: block;
            position: absolute;
        }

        ul.navbar-nav li:hover li {
            float: none;
        }

        ul.navbar-nav ul ul {
            left: 100%;
            top: 0;
        }
    }
</style>
</head>
    <body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-yeti">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/Atlas.Orm/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
                            <a class="navbar-brand" href="/Atlas.Orm/">
                    <img alt="logo" src="https://raw.githubusercontent.com/atlasphp/atlasphp.github.io/master/images/atlas.png" title="Home">
                </a>
                    </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/Atlas.Orm/mapper/">Persistence Mapper</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/Atlas.Orm/mapper/getting-started.html">Getting Started</a>

    </li>
                        <li>
    <a href="/Atlas.Orm/mapper/relationships.html">Mapper Relationships</a>

    </li>
                        <li>
    <a href="/Atlas.Orm/mapper/reading.html">Fetching Records and RecordSets</a>

    </li>
                        <li>
    <a href="/Atlas.Orm/mapper/records.html">Working with Records</a>

    </li>
                        <li>
    <a href="/Atlas.Orm/mapper/record-sets.html">Working with RecordSets</a>

    </li>
                        <li>
    <a href="/Atlas.Orm/mapper/transactions.html">Transactions (Unit of Work)</a>

    </li>
                        <li>
    <a href="/Atlas.Orm/mapper/logic.html">Record and RecordSet Logic</a>

    </li>
                        <li>
    <a href="/Atlas.Orm/mapper/events.html">Events</a>

    </li>
                        <li>
    <a href="/Atlas.Orm/mapper/direct.html">Direct Queries</a>

    </li>
                        <li>
    <a href="/Atlas.Orm/mapper/domain.html">Domain Models</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/Atlas.Orm/skeleton/">Skeleton Generator</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/Atlas.Orm/skeleton/getting-started.html">Skeleton Generator</a>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/Atlas.Orm/">Atlas</a></li>
                                <li><a href="/Atlas.Orm/mapper/">Persistence Mapper</a></li>
                                <li class="active">Mapper Relationships</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#1-2" title="Mapper&#x20;Relationships">Mapper Relationships</a>
            </li>
                                <li>
                <a href="#1-2-1" title="Relationship&#x20;Key&#x20;Columns">Relationship Key Columns</a>
            </li>
                                <li>
                <a href="#1-2-2" title="Composite&#x20;Relationship&#x20;Keys">Composite Relationship K...</a>
            </li>
                                <li>
                <a href="#1-2-3" title="Case-Sensitivity">Case-Sensitivity</a>
            </li>
                                <li>
                <a href="#1-2-4" title="Simple&#x20;WHERE&#x20;Conditions">Simple WHERE Conditions</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="1-2">1.2. Mapper Relationships</h1>
<p>You can add relationships to a mapper inside its <code>setRelated()</code> method, calling
one of the four available relationship-definition methods:</p>
<ul>
<li>
<code>oneToOne($field, $mapperClass)</code> (aka "has one")</li>
<li>
<code>manyToOne($field, $mapperClass)</code> (aka "belongs to")</li>
<li>
<code>oneToMany($field, $mapperClass)</code> (aka "has many")</li>
<li>
<code>manyToMany($field, $mapperClass, $throughField)</code> (aka "has many through")</li>
</ul>
<p>The <code>$field</code> will become a field name on the returned Record object. That field
will be populated from the specified <code>$mapperClass</code> in Atlas. (In the case of
<code>manyToMany()</code>, the association mappings will come from the specified
<code>$throughField</code>.)</p>
<p>Here is an example:</p>
<pre><code class="language-php">&lt;?php
namespace App\DataSource\Thread;

use App\DataSource\Author\AuthorMapper;
use App\DataSource\Summary\SummaryMapper;
use App\DataSource\Reply\ReplyMapper;
use App\DataSource\Tagging\TaggingMapper;
use App\DataSource\Tag\TagMapper;
use Atlas\Orm\Mapper\AbstractMapper;

class ThreadMapper extends AbstractMapper
{
    protected function setRelated()
    {
        $this-&gt;manyToOne('author', AuthorMapper::CLASS);
        $this-&gt;oneToOne('summary', SummaryMapper::CLASS);
        $this-&gt;oneToMany('replies', ReplyMapper::CLASS);
        $this-&gt;oneToMany('taggings', TaggingMapper::CLASS);
        $this-&gt;manyToMany('tags', TagMapper::CLASS, 'taggings');
    }
}
</code></pre>
<h2 id="1-2-1">1.2.1. Relationship Key Columns</h2>
<p>By default, in all relationships except many-to-one, the relationship will take
the primary key column(s) in the native table, and map to those same column
names in the foreign table.</p>
<p>In the case of many-to-one, it is the reverse; that is, the relationship will
take the primary key column(s) in the foreign table, and map to those same
column names in the native table.</p>
<p>If you want to use different columns, call the <code>on()</code> method on the
relationship. For example, if the threads table uses <code>author_id</code>, but the
authors table uses just <code>id</code>, you can do this:</p>
<pre><code class="language-php">&lt;?php
class ThreadMapper extends AbstractMapper
{
    protected function setRelated()
    {
        $this-&gt;manyToOne('author', AuthorMapper::CLASS)
            -&gt;on([
                // native (threads) column =&gt; foreign (authors) column
                'author_id' =&gt; 'id',
            ]);
        // ...
    }
}
</code></pre>
<p>And on the <code>oneToMany</code> side of the relationship, you use the native author table
<code>id</code> column with the foreign threads table <code>author_id</code> column.</p>
<pre><code class="language-php">&lt;?php
class AuthorMapper extends AbstractMapper
{
    protected function setRelated()
    {
        $this-&gt;oneToMany('posts', PostsMapper::CLASS)
            -&gt;on([
                // native (author) column =&gt; foreign (threads) column
                'id' =&gt; 'author_id',
            ]);
        // ...
    }
}
</code></pre>
<h2 id="1-2-2">1.2.2. Composite Relationship Keys</h2>
<p>Likewise, if a table uses a composite key, you can re-map the relationship on
multiple columns. If table <code>foo</code> has composite primary key columns of <code>acol</code> and
<code>bcol</code>, and it maps to table <code>bar</code> on <code>foo_acol</code> and <code>foo_bcol</code>, you would do
this:</p>
<pre><code class="language-php">&lt;?php
class FooMapper
{
    protected function setRelated()
    {
        $this-&gt;oneToMany('bars', BarMapper::CLASS)
            -&gt;on([
                // native (foo) column =&gt; foreign (bar) column
                'acol' =&gt; 'foo_acol',
                'bcol' =&gt; 'foo_bcol',
            ]);
    }
}
</code></pre>
<h2 id="1-2-3">1.2.3. Case-Sensitivity</h2>
<blockquote>
<p><strong>Note:</strong>
This applies only to <strong>string-based</strong> relationship keys. If you are
using numeric relationship keys, this section does not apply.</p>
</blockquote>
<p>Atlas will match records related by string keys in a case-senstive manner. If
your collations on the related string key columns are <em>not</em> case sensitive,
Atlas might not match up related records properly in memory after fetching them
from the database. This is because 'foo' and 'FOO' might be equivalent in the
database collation, but they are <em>not</em> equivalent in PHP.</p>
<p>In that kind of situation, you will want to tell the relationship to ignore the
case of related string key columns when matching related records. You can do so
with the <code>ignoreCase()</code> method on the relationship definition.</p>
<pre><code class="language-php">
&lt;?php
class FooMapper
{
    protected function setRelated()
    {
        $this-&gt;oneToMany('bars', BarMapper::CLASS)
            -&gt;ignoreCase();
    }
}
</code></pre>
<p>With that in place, a native value of 'foo' match to a foreign value of 'FOO'
when Atlas is stitching together related records.</p>
<h2 id="1-2-4">1.2.4. Simple WHERE Conditions</h2>
<p>You may find it useful to define simple WHERE conditions on the foreign side of
the relationship. For example, you can handle one side of a so-called
polymorphic relationship by selecting only related records of a particular type.</p>
<p>In the following example, a <code>comments</code> table has a <code>commentable_id</code> column as
the foreign key value, but is restricted to "issue" values on a discriminator
column named <code>commentable</code>.</p>
<pre><code class="language-php">class IssueMapper extends AbstractMapper
{
    protected function setRelated()
    {
        $this-&gt;oneToMany('comments', CommentMapper::CLASS)
            -&gt;on([
                'issue_id' =&gt; 'commentable_id'
            ])
            -&gt;where('commentable = ?', 'issue');
    }
}
</code></pre>
<p>(These conditions will be honored by <code>MapperSelect::*joinWith()</code> as well.)</p>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/Atlas.Orm/mapper/getting-started.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/Atlas.Orm/mapper/reading.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body>
</html>
